<!DOCTYPE html>
<html>
  <head>
	<title>K Draughts</title>
	
	<style>
		table {	border-collapse: collapse; }
		tr{	line-height: 0px; }
		td{	padding: 0;	}
	</style>

	<script>
	var url_base = 'http://127.0.0.1:5000/'
	var black_square_col = "#000000"
	var white_square_col = "lightyellow"
	var piece_colours = {'W': "salmon", 'WK': 'darkred', 'B': "royalblue", 'BK': 'mediumblue'}
	var square_size = 50
	var board_size = 8
	var player_names = {'W': 'White', 'B': 'Black'}

	function fillSquare(sq, col, piece){
		let canvas = document.getElementById(sq);
		let ctx = canvas.getContext("2d");
		ctx.fillStyle = col;
		ctx.fillRect(0, 0, square_size, square_size);
		
		if(piece!='E'){
			ctx.beginPath();
			ctx.fillStyle = piece_colours[piece]
			ctx.arc(square_size/2, square_size/2, 0.36*square_size, 0, 2 * Math.PI);
			ctx.fill();	
		}
		canvas.setAttribute('data-piece', piece)		
	}

	function drawBoard(){
		/*
		 Initialize the html table representing the board.
		 Each element is a square containing a canvas with id 'S23' for example.
		*/
		console.log("in drawBoard")
		let table = document.getElementById("board");
		for(i=0; i<board_size; i++){
			let row = table.insertRow(0)			
			for(j=0; j<board_size; j++){
				cell = row.insertCell(-1)
				sq = 'S' + String(i) + String(j)
				cell.innerHTML = `<canvas id=${sq} draggable="true" ondragstart="dragstart(event)" ondrop="dragDrop(event)" ondragover="allowDrop(event)"
				class="board_square" width=${square_size} height=${square_size} data-piece="E" <\/canvas>`
			}	
		}		
	}

	function update_board(position){
		/*
		Given a new position, update the board.
		*/
		board_pos = position['pos']
		tomove = position['tomove']
		for(i=0; i<board_size; i++){			
			for(j=0; j<board_size; j++){
				sq = 'S' + String(i) + String(j)
				if((i+j)%2==0) {col = black_square_col} else {col = white_square_col}
				fillSquare(sq, col, board_pos[sq])
			}	
		}
		document.getElementById('to-move' ).setAttribute('to-move', tomove)
		document.getElementById('to-move-box' ).setAttribute('style','fill:' + piece_colours[tomove] )

		winner = position['winner']
		if(winner != null){
			document.getElementById('move_button').disabled = true
			document.getElementById('indicator').innerHTML = player_names[winner] + " wins!"
		}	
	}

	function restart_game(){
		document.getElementById('move_button').disabled = false
		get_update('initial_position')
	}

	function get_position(){
		"Returns an object representing the current board position."
		let pos = {}
		board_squares = document.getElementsByClassName('board_square')
		for(board_square of board_squares){
			sq = board_square.getAttribute('id')
			piece = board_square.getAttribute('data-piece')
			pos[sq] = piece
		}
		tomove = document.getElementById('to-move').getAttribute('to-move')
		ret = {pos: pos, tomove: tomove}

		return(ret)
	}
	
	function get_update(s){
		url = url_base + s
		fetch(url).then(response => response.json()).then(json => update_board(json));
	}

	function getMoveFromServer(){
		pos = get_position()
		pos_json = JSON.stringify(pos)
		get_update("pos/" + pos_json)	
	}

	function play_move(move){
		// Move is of the format S12_S23.
		// 1. Sends the move to the server
		// 2. Gets back the new board and calls update_board
		// 3. Requests the server to play a move
		
		pos = get_position()
		pos['move'] = move
		pos_and_move_json = JSON.stringify(pos)

		fetch(url_base + "move/" + pos_and_move_json).then(response => response.json()).then(json => update_board(json)).then(x => getMoveFromServer());
	}

	function dragstart(event){
		source_ID = event.target.id
		event.dataTransfer.setData("some_text", source_ID);
	}

	function dragDrop(event){
		event.preventDefault(); 
		orig = event.dataTransfer.getData("some_text"); 
		dest = event.target.id
		let move = orig + "_" + dest
		console.log(`move ${move}`)
		play_move(move)
		console.log('move played')
	}

	function allowDrop(event){
		event.preventDefault(); 
	}

	</script>
  
</head>
  
  <body>
	 <h2 id="indicator">Let's go!</h2>
	
	<button id='restart_button' type="button" onclick="restart_game()">Restart</button>
	<button id='move_button' type="button" onclick="getMoveFromServer()">Move</button>
	<div id='to-move' to-move="W"></div>

	<br>

	<svg width="40" height="20">
		<rect id='to-move-box' width="40" height="20" style="fill:rgb(0,0,255)"/>
	</svg>
	
		<br><br>
	<table id="board"> </table>

	<script>
		
		console.log("calling drawBoard")
		drawBoard()
		get_update('initial_position')


	</script>
	
  </body>
  
</html>


