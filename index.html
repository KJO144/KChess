<!DOCTYPE html>
<html>
  <head>
	<title>K Draughts</title>
	
	<style>
		table {	border-collapse: collapse; }
		tr{	line-height: 0px; }
		td{	padding: 0;	}
	</style>

	<script>
	var url_base = 'http://127.0.0.1:5000/'
	var black_square_col = "#000000"
	var white_square_col = "lightyellow"
	var piece_colours = {'W': "salmon", 'WK': 'darkred', 'B': "royalblue", 'BK': 'mediumblue'}
	var square_size = 50
	var board_size = 8

	function fillSquare(sq, col, piece){
		let canvas = document.getElementById(sq);
		let ctx = canvas.getContext("2d");
		ctx.fillStyle = col;
		ctx.fillRect(0, 0, square_size, square_size);
		
		if(piece!='E'){
			ctx.beginPath();
			ctx.fillStyle = piece_colours[piece]
			ctx.arc(square_size/2, square_size/2, 0.36*square_size, 0, 2 * Math.PI);
			ctx.fill();	
		}
		canvas.setAttribute('data-piece', piece)		
	}

	function drawBoard(){
		/*
		 Initialize the html table representing the board.
		 Each element is a square containing a canvas with id 'S23' for example.
		*/
		console.log("in drawBoard")
		let table = document.getElementById("board");
		for(i=0; i<board_size; i++){
			let row = table.insertRow(0)			
			for(j=0; j<board_size; j++){
				cell = row.insertCell(-1)
				sq = 'S' + String(i) + String(j)
				cell.innerHTML = "<canvas id=\"" + sq + "\" width=\"50\" height=\"50\" data-piece=\"E\" <\/canvas>"
			}	
		}		
	}

	function update_board(position){
		/*
		Given a new position, update the board.
		*/
		//console.log(position)
		board_pos = position['pos']
		tomove = position['tomove']
		for(i=0; i<board_size; i++){			
			for(j=0; j<board_size; j++){
				sq = 'S' + String(i) + String(j)
				if((i+j)%2==0){	col = black_square_col	} else { col = white_square_col }
				fillSquare(sq, col, board_pos[sq])
			}	
		}
		document.getElementById('board').setAttribute('to-move', tomove)
	}

	function get_position(){
		console.log("in get_position")
		let pos = {}
		for(i=0; i<board_size; i++){			
			for(j=0; j<board_size; j++){
				sq = 'S' + String(i) + String(j)
				let el = document.getElementById(sq)				
				pos[sq] = el.getAttribute('data-piece')
			}	
		}
		tomove = document.getElementById('board').getAttribute('to-move')
		ret = { pos: pos, tomove: tomove}

		return(JSON.stringify(ret))
	}
	
	function get_update(s) {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				json = JSON.parse(xhttp.responseText)
				document.getElementById('indicator').innerHTML = "Ready."
				update_board(json)
			}
		};
		document.getElementById('indicator').innerHTML = "Waiting..."
		xhttp.open('GET', url_base + s, true);
		xhttp.send();
	}

	function move(){
		pos = get_position()
		get_update("move/" + pos)
	}

	</script>
  
	

</head>
  
  <body>
    <!--<h1 id="demo">Welcome Talia</h1>-->
	 <h2 id="indicator"></h2>
	 
	<button type="button" onclick="move()">Move</button>
	
	<table id="board" to-move="W"> </table>

	<script>
		
		console.log("calling drawBoard")
		drawBoard()
		get_update('initial_position')


	</script>
	
  </body>
  
</html>


