<!DOCTYPE html>
<html>
  <head>
	<title>K Draughts</title>
	
	<style>
		table {	border-collapse: collapse; }
		tr{	line-height: 0px; }
		td{	padding: 0;	}
	</style>

	<script>
	var url_base = 'http://127.0.0.1:5000/'
	var black_square_col = "#000000"
	var white_square_col = "lightyellow"
	var piece_colours = {'W': "salmon", 'WK': 'darkred', 'B': "royalblue", 'BK': 'mediumblue'}
	var square_size = 50
	var board_size = 8

	function fillSquare(sq, col, piece){
		let canvas = document.getElementById(sq);
		let ctx = canvas.getContext("2d");
		ctx.fillStyle = col;
		ctx.fillRect(0, 0, square_size, square_size);
		
		if(piece!='E'){
			ctx.beginPath();
			ctx.fillStyle = piece_colours[piece]
			ctx.arc(square_size/2, square_size/2, 0.36*square_size, 0, 2 * Math.PI);
			ctx.fill();	
		}
		canvas.setAttribute('data-piece', piece)		
	}

	function drawBoard(){
		/*
		 Initialize the html table representing the board.
		 Each element is a square containing a canvas with id 'S23' for example.
		*/
		console.log("in drawBoard")
		let table = document.getElementById("board");
		for(i=0; i<board_size; i++){
			let row = table.insertRow(0)			
			for(j=0; j<board_size; j++){
				cell = row.insertCell(-1)
				sq = 'S' + String(i) + String(j)
				cell.innerHTML = `<canvas id=${sq} class="board_square" width=${square_size} height=${square_size} data-piece="E" <\/canvas>`
			}	
		}		
	}

	function update_board(position){
		/*
		Given a new position, update the board.
		*/
		board_pos = position['pos']
		tomove = position['tomove']
		for(i=0; i<board_size; i++){			
			for(j=0; j<board_size; j++){
				sq = 'S' + String(i) + String(j)
				if((i+j)%2==0) {col = black_square_col} else {col = white_square_col}
				fillSquare(sq, col, board_pos[sq])
			}	
		}
		document.getElementById('to-move' ).setAttribute('to-move', tomove)
		document.getElementById('to-move-box' ).setAttribute('style','fill:' + piece_colours[tomove] )

		winner = position['winner']
		if(winner != null){
			document.getElementById('move_button').disabled = true
			document.getElementById('indicator').innerHTML = winner + " wins!"
		}	
	}

	function restart_game(){
		document.getElementById('move_button').disabled = false
		get_update('initial_position')
	}

	function get_position(){
		"Returns a JSON representation of the current board position."
		let pos = {}
		board_squares = document.getElementsByClassName('board_square')
		for(board_square of board_squares){
			sq = board_square.getAttribute('id')
			piece = board_square.getAttribute('data-piece')
			pos[sq] = piece
		}
		tomove = document.getElementById('to-move').getAttribute('to-move')
		ret = {pos: pos, tomove: tomove}

		return(JSON.stringify(ret))
	}
	
	function get_update(s) {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				json = JSON.parse(xhttp.responseText)
				document.getElementById('indicator').innerHTML = "Ready."
				update_board(json)
			}
		};
		document.getElementById('indicator').innerHTML = "Waiting..."
		xhttp.open('GET', url_base + s, true);
		xhttp.send();
	}

	function move(){
		pos = get_position()
		get_update("move/" + pos)
	}

	</script>
  
	

</head>
  
  <body>
	 <h2 id="indicator"></h2>
	
	<button id='restart_button' type="button" onclick="restart_game()">Restart</button>
	<button id='move_button' type="button" onclick="move()">Move</button>
	<div id='to-move' to-move="W"></div>

	<br>

	<!-- <div id="rectangle" style="width:20 px; height:20 px; background-color:blue">TOMOVE</div> -->
	<svg width="40" height="20">
		<rect id='to-move-box' width="40" height="20" style="fill:rgb(0,0,255)"/>
	</svg>
	
	<br><br>
	<table id="board"> </table>

	<script>
		
		console.log("calling drawBoard")
		drawBoard()
		get_update('initial_position')


	</script>
	
  </body>
  
</html>


